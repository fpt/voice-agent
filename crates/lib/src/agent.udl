namespace agent_core {
    [Throws=AgentError]
    Agent agent_new(AgentConfig config);
};

[Error]
enum AgentError {
    "NetworkError",
    "ParseError",
    "ConfigError",
    "InternalError",
};

dictionary McpServerConfig {
    string command;
    sequence<string> args;
};

dictionary AgentConfig {
    string? model_path;
    string base_url;
    string model;
    string? api_key;
    boolean use_harmony_template;
    f32? temperature;
    u32 max_tokens;
    u32 context_window;
    string? language;
    string? working_dir;
    string? reasoning_effort;
    sequence<McpServerConfig> mcp_servers;
};

dictionary AgentResponse {
    string content;
    string role;
    boolean is_final;
    sequence<string>? keywords;
    string? reasoning;
    u64 input_tokens;
    u64 output_tokens;
    u64 total_tokens;
    f32 context_percent;
};

dictionary CaptureRequest {
    string id;
    u32? window_id;
    f64? crop_x;
    f64? crop_y;
    f64? crop_w;
    f64? crop_h;
    boolean? detect;
    boolean? apply_ocr;
    string? search_keywords;
};

interface Agent {
    [Throws=AgentError]
    AgentResponse step(string user_input);

    string? process_backchannel(string partial_input, u64 pause_ms);

    void reset();

    string get_conversation_history();

    void set_system_prompt(string prompt);

    void add_skill(string name, string description, string prompt);

    [Throws=AgentError]
    AgentResponse step_with_allowed_tools(string user_input, sequence<string> allowed_tools);

    [Throws=AgentError]
    void feed_watcher_event(string json);

    sequence<CaptureRequest> drain_capture_requests();

    void submit_capture_result(string id, string image_base64, string metadata_json);

    void push_situation_message(string text, string source, string session_id);
};
